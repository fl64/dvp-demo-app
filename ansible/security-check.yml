---
- name: Security checks for virtual machines
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    - name: Check for security updates
      command: apk list --upgradable
      register: security_updates
      changed_when: false
      when: ansible_os_family == "Alpine"
    
    - name: Display security updates count
      debug:
        msg: "{{ inventory_hostname }}: Security updates available - {{ security_updates.stdout_lines | length }}"
      when: ansible_os_family == "Alpine"
    
    - name: Check SSH configuration file exists
      stat:
        path: /etc/ssh/sshd_config
      register: ssh_config
    
    - name: Verify SSH config permissions
      file:
        path: /etc/ssh/sshd_config
        mode: '0600'
        owner: root
        group: root
      when: ssh_config.stat.exists
      register: ssh_config_fixed
    
    - name: Report SSH config permissions fix
      debug:
        msg: "{{ inventory_hostname }}: Fixed SSH config permissions"
      when: ssh_config_fixed.changed
    
    - name: Check if root login is disabled
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        backup: yes
      register: ssh_root_login
      when: ssh_config.stat.exists
    
    - name: Report SSH root login disabled
      debug:
        msg: "{{ inventory_hostname }}: Disabled root login via SSH"
      when: ssh_root_login.changed
    
    - name: Check SSH authorized_keys permissions
      stat:
        path: /home/{{ ansible_user }}/.ssh/authorized_keys
      register: authorized_keys
      when: ansible_user is defined
    
    - name: Fix authorized_keys permissions
      file:
        path: /home/{{ ansible_user }}/.ssh/authorized_keys
        mode: '0600'
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      when: authorized_keys.stat.exists
      register: auth_keys_fixed
    
    - name: Report authorized_keys permissions fix
      debug:
        msg: "{{ inventory_hostname }}: Fixed authorized_keys permissions"
      when: auth_keys_fixed.changed
    
    - name: Check listening ports
      command: netstat -tuln
      register: listening_ports
      changed_when: false
      failed_when: false
    
    - name: Display listening ports
      debug:
        msg: "{{ inventory_hostname }} listening ports: {{ listening_ports.stdout_lines }}"
      when: listening_ports.rc == 0
    
    - name: Check running services
      command: rc-status
      register: running_services
      changed_when: false
      failed_when: false
    
    - name: Display running services
      debug:
        msg: "{{ inventory_hostname }} running services: {{ running_services.stdout_lines }}"
      when: running_services.rc == 0
    
    - name: Check disk usage
      command: df -h
      register: disk_usage
      changed_when: false
    
    - name: Display disk usage
      debug:
        msg: "{{ inventory_hostname }} disk usage:"
      when: disk_usage.rc == 0
    
    - name: Show disk usage details
      debug:
        var: disk_usage.stdout_lines
      when: disk_usage.rc == 0
    
    - name: Check for world-writable files in critical directories
      command: find /etc /usr /var -type f -perm -002 2>/dev/null | head -20
      register: world_writable
      changed_when: false
      failed_when: false
    
    - name: Display world-writable files warning
      debug:
        msg: "{{ inventory_hostname }}: Found {{ world_writable.stdout_lines | length }} world-writable files"
      when: 
        - world_writable.rc == 0
        - world_writable.stdout_lines | length > 0
    
    - name: Show world-writable files
      debug:
        var: world_writable.stdout_lines
      when:
        - world_writable.rc == 0
        - world_writable.stdout_lines | length > 0
        - world_writable.stdout_lines | length <= 10
    
    - name: Check system uptime
      command: uptime
      register: uptime_info
      changed_when: false
    
    - name: Display system uptime
      debug:
        msg: "{{ inventory_hostname }}: {{ uptime_info.stdout }}"
    
    - name: Security check summary
      debug:
        msg: "{{ inventory_hostname }}: Security check completed"
